<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.mapper.StudentWorkMapper">
    
    <resultMap type="org.example.domain.StudentWork" id="StudentWorkResult">
        <result property="id"    column="id"    />
        <result property="taskId"    column="task_id"    />
        <result property="taskTestId"    column="task_test_id"    />
        <result property="dataManageId"    column="data_manage_id"    />
        <result property="studentId"    column="student_id"    />
        <result property="teacherId"    column="teacher_id"    />
        <result property="quantity"    column="quantity"    />
        <result property="lastDate"    column="last_date"    />
        <result property="status"    column="status"    />
        <result property="criticizeStatus"    column="criticize_status"    />
        <result property="score"    column="score"    />
        <result property="remark"    column="remark"    />
        <result property="delFlag"    column="del_flag"    />
    </resultMap>

    <resultMap type="org.example.domain.vo.StudentWorkVo" id="StudentWorkVoResult">
        <result property="id"    column="id"    />
        <result property="taskId"    column="task_id"    />
        <result property="taskTestId"    column="task_test_id"    />
        <result property="dataManageId"    column="data_manage_id"    />
        <result property="studentId"    column="student_id"    />
        <result property="teacherId"    column="teacher_id"    />
        <result property="quantity"    column="quantity"    />
        <result property="lastDate"    column="last_date"    />
        <result property="status"    column="status"    />
        <result property="criticizeStatus"    column="criticize_status"    />
        <result property="score"    column="score"    />
        <result property="remark"    column="remark"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="taskTitle"  column="taskTitle"/>
        <result property="testTestTitle" column="taskTestTilte" />
        <result property="studentName" column="studentName"/>
        <result property="teacherName" column="teacherName"/>
    </resultMap>

    <sql id="selectStudentWorkVo">
        select id, task_id, task_test_id, data_manage_id, student_id, teacher_id, quantity, last_date, status, criticize_status, score, remark, del_flag from student_work
    </sql>

    <sql id="selectStudentWorkVoDemo">
        SELECT
            sw.id,
            sw.task_id,
            sw.task_test_id,
            sw.data_manage_id,
            sw.student_id,
            sw.teacher_id,
            sw.quantity,
            sw.last_date,
            sw.status,
            sw.criticize_status,
            sw.score,
            sw.remark,
            sw.del_flag,
            ss.user_name AS studentName,
            sss.user_name AS teacherName,
            tt.title AS taskTitle,
            ttt.title AS taskTestTilte
        FROM
            student_work sw
                JOIN
            teach_task tt ON sw.task_id = tt.id
                JOIN
            teach_task_test ttt ON sw.task_test_id = ttt.id
                JOIN
            sys_user ss ON sw.student_id = ss.user_id
                JOIN
            sys_user sss ON sw.teacher_id = sss.user_id

    </sql>

    <select id="selectStudentWorkList" parameterType="org.example.domain.StudentWork" resultMap="StudentWorkResult">
        <include refid="selectStudentWorkVo"/>
        <where>
            <if test="taskId != null "> and task_id = #{taskId}</if>
            <if test="id != null "> and id = #{id}</if>
            <if test="taskTestId != null "> and task_test_id = #{taskTestId}</if>
            <if test="dataManageId != null "> and data_manage_id = #{dataManageId}</if>
            <if test="studentId != null "> and student_id = #{studentId}</if>
            <if test="teacherId != null "> and teacher_id = #{teacherId}</if>
            <if test="quantity != null "> and quantity = #{quantity}</if>
            <if test="lastDate != null "> and last_date = #{lastDate}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="criticizeStatus != null  and criticizeStatus != ''"> and criticize_status = #{criticizeStatus}</if>
            <if test="score != null "> and score = #{score}</if>
            <if test="delFlag != null">and del_flag = '0' </if>
        </where>
    </select>
    
    <select id="selectStudentWorkById" parameterType="Long" resultMap="StudentWorkResult">
        <include refid="selectStudentWorkVo"/>
        where id = #{id} and del_flag = '0'
    </select>

    <select id="selectStudentWorkVoById" parameterType="Long" resultMap="StudentWorkVoResult">
        <include refid="selectStudentWorkVoDemo"/>
        where sw.id = #{id} and sw.del_flag = '0'
    </select>

    <select id="selectStudentWorkVoList" resultMap="StudentWorkVoResult">
        <include refid="selectStudentWorkVoDemo"/>
        where sw.del_flag = '0'
    </select>


    <insert id="insertStudentWork" parameterType="org.example.domain.StudentWork" useGeneratedKeys="true" keyProperty="id">
        insert into student_work
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="taskId != null">task_id,</if>
            <if test="taskTestId != null">task_test_id,</if>
            <if test="dataManageId != null">data_manage_id,</if>
            <if test="studentId != null">student_id,</if>
            <if test="teacherId != null">teacher_id,</if>
            <if test="quantity != null">quantity,</if>
            <if test="lastDate != null">last_date,</if>
            <if test="status != null">status,</if>
            <if test="criticizeStatus != null">criticize_status,</if>
            <if test="score != null">score,</if>
            <if test="remark != null">remark,</if>
            <if test="delFlag != null">del_flag,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="taskId != null">#{taskId},</if>
            <if test="taskTestId != null">#{taskTestId},</if>
            <if test="dataManageId != null">#{dataManageId},</if>
            <if test="studentId != null">#{studentId},</if>
            <if test="teacherId != null">#{teacherId},</if>
            <if test="quantity != null">#{quantity},</if>
            <if test="lastDate != null">#{lastDate},</if>
            <if test="status != null">#{status},</if>
            <if test="criticizeStatus != null">#{criticizeStatus},</if>
            <if test="score != null">#{score},</if>
            <if test="remark != null">#{remark},</if>
            <if test="delFlag != null">#{delFlag},</if>
         </trim>
    </insert>

    <update id="updateStudentWork" parameterType="org.example.domain.StudentWork">
        update student_work
        <trim prefix="SET" suffixOverrides=",">
            <if test="taskId != null">task_id = #{taskId},</if>
            <if test="taskTestId != null">task_test_id = #{taskTestId},</if>
            <if test="dataManageId != null">data_manage_id = #{dataManageId},</if>
            <if test="studentId != null">student_id = #{studentId},</if>
            <if test="teacherId != null">teacher_id = #{teacherId},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="lastDate != null">last_date = #{lastDate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="criticizeStatus != null">criticize_status = #{criticizeStatus},</if>
            <if test="score != null">score = #{score},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteStudentWorkById" parameterType="Long">
        update student_work set del_flag = '1' where id = #{id}
    </delete>

    <delete id="deleteStudentWorkByIds" parameterType="String">
        update student_work set del_flag = '1' where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="getStatisticSummary" resultType="org.example.domain.vo.StudentWorkStatisticVo">
        SELECT COUNT(1) AS totalCount, SUM(CASE WHEN sw.status = '1' THEN 1 ELSE 0 END) AS submitCount, SUM(CASE WHEN sw.criticize_status = '1' THEN 1 ELSE 0 END) AS reviewedCount, AVG(sw.score) AS avgScore, MAX(sw.score) AS maxScore, MIN(sw.score) AS minScore FROM student_work sw WHERE sw.del_flag = '0'
        <if test="taskId != null"> AND sw.task_id = #{taskId} </if>
        <if test="testId != null"> AND sw.task_test_id = #{testId} </if>
    </select>

    <select id="getStudentWorkByTaskAndTestId" resultType="org.example.domain.StudentWork">
        <include refid="selectStudentWorkVo"/>
        <if test="taskId != null"> AND task_id = #{taskId} </if>
        <if test="testId != null"> AND task_test_id = #{testId} </if>
    </select>

    <update id="markExpiredPendingWorksAsDeleted">
        UPDATE student_work sw
        JOIN teach_task tt ON sw.task_id = tt.id
        SET sw.del_flag = '1'
        WHERE sw.del_flag = '0'
        AND tt.end_date &lt; #{now}
        AND sw.status = '0'        <!-- 进行中 -->
        AND sw.criticize_status = '0' <!-- 待提交 -->
    </update>

</mapper>